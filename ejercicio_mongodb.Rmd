---
title: "Untitled"
author: "Camilo Vega"
date: "2023-04-18"
output: pdf_document
---

```{r}

```

#Punto A
```{bash eval=FALSE}
university.carreras.aggregate([
  {
    $match:
      /**
       * query: The query in MQL.
       */
      {
        nombre: "Ingeniería de Sistemas",
      },
  },
  {
    $unwind:
      /**
       * path: Path to the array field.
       * includeArrayIndex: Optional name for index.
       * preserveNullAndEmptyArrays: Optional
       *   toggle to unwind null and empty values.
       */
      {
        path: "$cursos",
        preserveNullAndEmptyArrays: true,
      },
  },
  {
    $project:
      /**
       * specifications: The fields to
       *   include or exclude.
       */
      {
        curso: "$cursos.curso",
      },
  },
  {
    $lookup:
      /**
       * from: The target collection.
       * localField: The local join field.
       * foreignField: The target join field.
       * as: The name for the results.
       * pipeline: Optional pipeline to run on the foreign collection.
       * let: Optional variables to use in the pipeline field stages.
       */
      {
        from: "cursos",
        localField: "curso",
        foreignField: "_id",
        as: "curso",
      },
  },
  {
    $unwind:
      /**
       * path: Path to the array field.
       * includeArrayIndex: Optional name for index.
       * preserveNullAndEmptyArrays: Optional
       *   toggle to unwind null and empty values.
       */
      {
        path: "$curso",
        preserveNullAndEmptyArrays: true,
      },
  },
  {
    $lookup:
      /**
       * from: The target collection.
       * localField: The local join field.
       * foreignField: The target join field.
       * as: The name for the results.
       * pipeline: Optional pipeline to run on the foreign collection.
       * let: Optional variables to use in the pipeline field stages.
       */
      {
        from: "profesores",
        localField: "curso.profesor",
        foreignField: "_id",
        as: "profesor",
      },
  },
  {
    $unwind:
      /**
       * path: Path to the array field.
       * includeArrayIndex: Optional name for index.
       * preserveNullAndEmptyArrays: Optional
       *   toggle to unwind null and empty values.
       */
      {
        path: "$profesor",
        preserveNullAndEmptyArrays: true,
      },
  },
  {
    $project:
      /**
       * specifications: The fields to
       *   include or exclude.
       */
      {
        _id: 0,
        curso: "$curso.nombre",
        profesor: "$profesor.nombre",
        salon: {
          $concat: [
            {
              $arrayElemAt: [
                "$curso.calendario.salon",
                0,
              ],
            },
            " - Edificio: ",
            {
              $arrayElemAt: [
                "$curso.calendario.edificio",
                0,
              ],
            },
          ],
        },
        horarios: {
          $map: {
            input: "$curso.calendario",
            as: "c",
            in: {
              $concat: [
                "$$c.dia",
                " ",
                "$$c.inicio",
                " - ",
                "$$c.fin",
              ],
            },
          },
        },
      },
  },
])
```

```{python}
from pymongo import MongoClient

# Requires the PyMongo package.
# https://api.mongodb.com/python/current

client = MongoClient('mongodb://localhost:27017/')
result = client['university']['carreras'].aggregate([
    {
        '$match': {
            'nombre': 'Ingeniería de Sistemas'
        }
    }, {
        '$unwind': {
            'path': '$cursos', 
            'preserveNullAndEmptyArrays': True
        }
    }, {
        '$project': {
            'curso': '$cursos.curso'
        }
    }, {
        '$lookup': {
            'from': 'cursos', 
            'localField': 'curso', 
            'foreignField': '_id', 
            'as': 'curso'
        }
    }, {
        '$unwind': {
            'path': '$curso', 
            'preserveNullAndEmptyArrays': True
        }
    }, {
        '$lookup': {
            'from': 'profesores', 
            'localField': 'curso.profesor', 
            'foreignField': '_id', 
            'as': 'profesor'
        }
    }, {
        '$unwind': {
            'path': '$profesor', 
            'preserveNullAndEmptyArrays': True
        }
    }, {
        '$project': {
            '_id': 0, 
            'curso': '$curso.nombre', 
            'profesor': '$profesor.nombre', 
            'salon': {
                '$concat': [
                    {
                        '$arrayElemAt': [
                            '$curso.calendario.salon', 0
                        ]
                    }, ' - Edificio: ', {
                        '$arrayElemAt': [
                            '$curso.calendario.edificio', 0
                        ]
                    }
                ]
            }, 
            'horarios': {
                '$map': {
                    'input': '$curso.calendario', 
                    'as': 'c', 
                    'in': {
                        '$concat': [
                            '$$c.dia', ' ', '$$c.inicio', ' - ', '$$c.fin'
                        ]
                    }
                }
            }
        }
    }
])
```


```{python}
import pprint

pprint.pprint(list(result))
```


# Punto B

```{bash eval=FALSE}
[
  {
    $unwind:
      /**
       * path: Path to the array field.
       * includeArrayIndex: Optional name for index.
       * preserveNullAndEmptyArrays: Optional
       *   toggle to unwind null and empty values.
       */
      {
        path: "$cursos",
        preserveNullAndEmptyArrays: true,
      },
  },
  {
    $project:
      /**
       * specifications: The fields to
       *   include or exclude.
       */
      {
        _id: 0,
        carrera: "$nombre",
        id_curso: "$cursos.curso",
      },
  },
  {
    $lookup:
      /**
       * from: The target collection.
       * localField: The local join field.
       * foreignField: The target join field.
       * as: The name for the results.
       * pipeline: Optional pipeline to run on the foreign collection.
       * let: Optional variables to use in the pipeline field stages.
       */
      {
        from: "cursos",
        localField: "id_curso",
        foreignField: "_id",
        as: "curso",
      },
  },
  {
    $unwind:
      /**
       * path: Path to the array field.
       * includeArrayIndex: Optional name for index.
       * preserveNullAndEmptyArrays: Optional
       *   toggle to unwind null and empty values.
       */
      {
        path: "$curso",
        preserveNullAndEmptyArrays: true,
      },
  },
  {
    $project:
      /**
       * specifications: The fields to
       *   include or exclude.
       */
      {
        _id: 0,
        carrera: "$carrera",
        curso: "$curso.nombre",
        id_profesor: "$curso.profesor",
      },
  },
  {
    $lookup:
      /**
       * from: The target collection.
       * localField: The local join field.
       * foreignField: The target join field.
       * as: The name for the results.
       * pipeline: Optional pipeline to run on the foreign collection.
       * let: Optional variables to use in the pipeline field stages.
       */
      {
        from: "profesores",
        localField: "id_profesor",
        foreignField: "_id",
        as: "profesor",
      },
  },
  {
    $unwind:
      /**
       * path: Path to the array field.
       * includeArrayIndex: Optional name for index.
       * preserveNullAndEmptyArrays: Optional
       *   toggle to unwind null and empty values.
       */
      {
        path: "$profesor",
        preserveNullAndEmptyArrays: false,
      },
  },
  {
    $project:
      /**
       * specifications: The fields to
       *   include or exclude.
       */
      {
        profesor: "$profesor.nombre",
        carrera: "$carrera",
        curso: "$curso",
      },
  },
  {
    $group:
      /**
       * _id: The id of the group.
       * fieldN: The first field name.
       */
      {
        _id: {
          profesor: "$profesor",
          carrera: "$carrera",
        },
        cursos: {
          $addToSet: "$curso",
        },
      },
  },
  {
    $group:
      /**
       * _id: The id of the group.
       * fieldN: The first field name.
       */
      {
        _id: "$_id.profesor",
        carreras_cursos: {
          $addToSet: {
            carrera: "$_id.carrera",
            cursos: "$cursos",
          },
        },
      },
  },
  {
    $project:
      /**
       * specifications: The fields to
       *   include or exclude.
       */
      {
        _id: 0,
        profesor: "$_id",
        careras_cursos: "$carreras_cursos",
      },
  },
  {
    $match:
      /**
       * query: The query in MQL.
       */
      {
        $expr: {
          $eq: [
            {
              $size: "$careras_cursos",
            },
            2,
          ],
        },
      },
  },
]
```

