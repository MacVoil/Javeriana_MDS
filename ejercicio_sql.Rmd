---
title: "SQL Excercise"
author: "Camilo Vega"
output:
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 3
toc-title: "Contenido"
linkcolor: blue
header-includes:
  - \usepackage{fontspec}
  - \setmonofont{Consolas}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(DBI)
library(tidyverse)
library(ggplot2)
library(odbc)
library(knitr)

con <- DBI::dbConnect(odbc::odbc(),
                      Driver   = "MySQL ODBC 8.0 Unicode Driver",
                      Database = "university",
                      Server   = "localhost",
                      UID      = "root",
                      PWD      = "+Mysql04981",
                      Port     = 3306)

```

---

# Punto A

> Listar todos los cursos ofrecidos en la carrera de Ingeniería de Sistemas. Para este caso se debe tener en cuenta que un mismo curso puede ser dictado por profesores diferentes, en salones diferentes y en horarios diferentes. Se deben obtener los siguientes datos: el nombre del curso, el nombre completo del profesor que dicta el curso, el salón en que se dicta el curso y la hora en la que se dicta del curso.


## Query

***NOTA:*** Se utiliza la cláusula `DISTINCT` en el QUERY para obtener valores únicos, dado que en los datos actuales los cursos que se dictan en distintos días tienen el mismo horario. Si en el futuro esta situación cambia  se recomienda incluir el campo DIA en la consulta, y eliminar la cláusula `DISTINCT`."

```{sql message=FALSE, warning=FALSE, connection=con, eval=FALSE, font.family = "Consolas"}

SELECT DISTINCT
    CURSOS.NOMBRE AS CURSO,
    USUARIOS.NOMBRE|| ' ' ||APELLIDO AS PROFESOR,
    SALONES.NOMBRE AS SALON,
    HORA_INICIO || ' a ' || HORA_FIN AS HORARIO
FROM CALENDARIO_CURSOS
JOIN CURSOS
    ON CALENDARIO_CURSOS.ID_CURSO = CURSOS.ID_CURSO
JOIN CURSOS_CARRERAS
    ON CURSOS.ID_CURSO = CURSOS_CARRERAS.ID_CURSO
JOIN CARRERAS
    ON CURSOS_CARRERAS.ID_CARRERA = CARRERAS.ID_CARRERA
JOIN USUARIOS
    ON CALENDARIO_CURSOS.ID_PROFESOR = USUARIOS.ID_USUARIO
JOIN SALONES
    ON CALENDARIO_CURSOS.ID_SALON = SALONES.ID_SALON
WHERE CARRERAS.NOMBRE = 'Ingeniería de Sistemas'
ORDER BY CURSOS.NOMBRE;

```


## Resultado

```{r echo=FALSE, paged.print=TRUE}

tbl(con, "CALENDARIO_CURSOS") |> 
  left_join(tbl(con, "CURSOS"), by = "ID_CURSO") |>
  left_join(tbl(con, "CURSOS_CARRERAS"), by = "ID_CURSO") |> 
  left_join(tbl(con, "CARRERAS"), by = "ID_CARRERA") |> 
  left_join(tbl(con, "USUARIOS"), by = c("ID_PROFESOR" = "ID_USUARIO")) |> 
  left_join(tbl(con, "SALONES"), by = "ID_SALON") |> 
  filter(ID_CARRERA == 1) |> 
  select(NOMBRE.x, NOMBRE.x.x, APELLIDO, NOMBRE.y.y, HORA_INICIO, HORA_FIN) |>
  rename(CURSO = NOMBRE.x, 
         NOMBRE_PROFESOR = NOMBRE.x.x,
         APELLIDO_PROFESOR = APELLIDO,
         SALON = NOMBRE.y.y) |> collect() |> 
  unite(PROFESOR, c(NOMBRE_PROFESOR, APELLIDO_PROFESOR), sep = " ") |> 
  unite(HORARIO, c(HORA_INICIO, HORA_FIN), sep = " a ") |> 
  distinct() |> 
  arrange(CURSO) |> 
    kable()
```

---

# Punto B

> Obtener la lista de profesores que dictan cursos pertenecientes a la facultad de Humanidades. Se deben obtener los siguientes datos: el nombre completo del profesor y el nombre del curso que dicta.

## Query

```{sql message=FALSE, warning=FALSE, connection=con, eval=FALSE, font.family = "Consolas"}

SELECT DISTINCT
    USUARIOS.NOMBRE|| ' ' ||APELLIDO AS PROFESOR,
    CURSOS.NOMBRE AS CURSO
FROM CALENDARIO_CURSOS
JOIN CURSOS
    ON CALENDARIO_CURSOS.ID_CURSO = CURSOS.ID_CURSO
JOIN FACULTADES
    ON CURSOS.ID_FACULTAD = FACULTADES.ID_FACULTAD
JOIN USUARIOS
    ON CALENDARIO_CURSOS.ID_PROFESOR = USUARIOS.ID_USUARIO
WHERE FACULTADES.NOMBRE = 'Humanidades y Ciencias Sociales'
ORDER BY PROFESOR;

```

## Resultado

```{r echo=FALSE, paged.print=TRUE}

tbl(con, "CALENDARIO_CURSOS") |> 
  left_join(tbl(con, "CURSOS"), by = "ID_CURSO") |>
  left_join(tbl(con, "FACULTADES"), by = "ID_FACULTAD") |> 
  left_join(tbl(con, "USUARIOS"), by = c("ID_PROFESOR" = "ID_USUARIO")) |> 
  filter(ID_FACULTAD == 2) |> 
  select(NOMBRE, APELLIDO, NOMBRE.x) |>
  distinct() |>
  rename(CURSO = NOMBRE.x) |> collect() |> 
  unite(PROFESOR, c(NOMBRE, APELLIDO), sep = " ") |> 
  arrange(PROFESOR) |> 
    kable()
```

---

# Punto C

> Obtener la lista de profesores que dictan cursos en **dos** carreras diferentes. Se deben obtener los siguientes datos: el nombre completo del profesor, el nombre del curso que dicta y el nombre de la carrera a la que pertenece el curso. Pista: averigua cómo funciona la sentencia **WITH**.

## Query

```{sql message=FALSE, warning=FALSE, connection=con, eval=FALSE, font.family = "Consolas"}

WITH p2c AS(
    SELECT DISTINCT
      USUARIOS.ID_USUARIO,
      USUARIOS.NOMBRE,
      APELLIDO
    FROM CALENDARIO_CURSOS
    JOIN CURSOS
      ON CALENDARIO_CURSOS.ID_CURSO = CURSOS.ID_CURSO
    JOIN CURSOS_CARRERAS
      ON CALENDARIO_CURSOS.ID_CURSO = CURSOS_CARRERAS.ID_CURSO
    JOIN CARRERAS
      ON CURSOS_CARRERAS.ID_CARRERA = CARRERAS.ID_CARRERA
    JOIN USUARIOS
      ON CALENDARIO_CURSOS.ID_PROFESOR = USUARIOS.ID_USUARIO
    GROUP BY USUARIOS.ID_USUARIO, USUARIOS.NOMBRE, APELLIDO
       HAVING COUNT(DISTINCT CARRERAS.ID_CARRERA) = 2
)
SELECT DISTINCT
    p2c.NOMBRE|| ' ' ||p2c.APELLIDO AS PROFESOR,
    CURSOS.NOMBRE AS CURSO,
    CARRERAS.NOMBRE AS CARRERA
FROM p2c
JOIN CALENDARIO_CURSOS
    ON p2c.ID_USUARIO = CALENDARIO_CURSOS.ID_PROFESOR
JOIN CURSOS
    ON CALENDARIO_CURSOS.ID_CURSO = CURSOS.ID_CURSO
JOIN CURSOS_CARRERAS
    ON CURSOS.ID_CURSO = CURSOS_CARRERAS.ID_CURSO
JOIN CARRERAS
    ON CURSOS_CARRERAS.ID_CARRERA = CARRERAS.ID_CARRERA
ORDER by PROFESOR, CARRERA;

```

## Resultado

```{r echo=FALSE, paged.print=TRUE}

tbl(con, "CALENDARIO_CURSOS") |> 
  left_join(tbl(con, "CURSOS"), by = "ID_CURSO") |>
  left_join(tbl(con, "CURSOS_CARRERAS"), by = "ID_CURSO") |> 
  left_join(tbl(con, "CARRERAS"), by = "ID_CARRERA") |> 
  left_join(tbl(con, "USUARIOS"), by = c("ID_PROFESOR" = "ID_USUARIO")) |>  
  select(NOMBRE, APELLIDO, NOMBRE.x, NOMBRE.y) |>
  rename(CURSO = NOMBRE.x,
         CARRERA = NOMBRE.y) |>  
  collect() |> 
  unite(PROFESOR, c(NOMBRE, APELLIDO), sep = " ") |> 
  distinct() |> 
  group_by(PROFESOR) |> 
  filter(n_distinct(CARRERA) == 2) |> 
  arrange(PROFESOR, CARRERA) |> 
  kable()
```

---

# Punto E

> Listar los estudiantes que se han inscrito a un curso determinado. Se deben obtener los siguientes datos: el nombre completo del estudiante y el nombre del curso.

## Query

***NOTA:*** Es posible sustituir el nombre del curso deseado en la cláusula `WHERE` para encontrar a los estudiantes que se hayan matriculado en él.

```{sql message=FALSE, warning=FALSE, connection=con, eval=FALSE, font.family = "Consolas"}

SELECT DISTINCT 
    USUARIOS.NOMBRE|| ' ' ||APELLIDO AS ESTUDIANTE,
    CURSOS.NOMBRE AS CURSO
FROM CURSOS_ESTUDIANTES
JOIN CALENDARIO_CURSOS
    ON CURSOS_ESTUDIANTES.ID_CALENDARIO = CALENDARIO_CURSOS.ID_CALENDARIO
JOIN CURSOS
    ON CALENDARIO_CURSOS.ID_CURSO = CURSOS.ID_CURSO
JOIN USUARIOS
    ON CURSOS_ESTUDIANTES.ID_USUARIO = USUARIOS.ID_USUARIO
WHERE CURSOS.NOMBRE = 'Cálculo Diferencial'
ORDER BY ESTUDIANTE;

```

## Resultado

```{r echo=FALSE, paged.print=TRUE}

tbl(con, "CURSOS_ESTUDIANTES") |> 
  left_join(tbl(con, "CALENDARIO_CURSOS"), by = "ID_CALENDARIO") |>
  left_join(tbl(con, "CURSOS"), by = "ID_CURSO") |> 
  left_join(tbl(con, "USUARIOS"), by = "ID_USUARIO") |> 
  select(NOMBRE.y, APELLIDO, NOMBRE.x) |>
  rename(NOMBRE = NOMBRE.y,
         CURSO = NOMBRE.x) |>  
  collect() |> 
  unite(ESTUDIANTE, c(NOMBRE, APELLIDO), sep = " ") |> 
  distinct() |> 
  filter(CURSO == "Cálculo Diferencial") |> 
  arrange(ESTUDIANTE) |> 
  kable()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
dbDisconnect(con)
```



