---
title: "EDA Carrera Luz"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(paqueteMET)
library(tidyverse)
library(plotly)
library(correlationfunnel)
library(ggdist)
library(tidyquant)
```

<style>
body {
text-align: justify;
}
</style>

**Introducción** {data-navmenu="Da Clic Aquí para el Menu"}
==================================

Column { data-width=250 }
-----------------------------------------------------------------------
### Fecha  {.value-box}
```{r}
valueBox(value = "2022-10-23", 
         caption = "Fecha", 
         icon = "fa-calendar", 
         color = "primary")
```

### Hora Inicio  {.value-box}
```{r}
valueBox(value = "7:00 AM", 
         caption = "Hora Inicio Aprox.", 
         icon = "ion-android-alarm-clock", 
         color = "primary")
```

### Tiempo Promedio  {.value-box}
```{r}
valueBox(value = str_c( (CarreraLuz22$timerun/60) %>% mean() %>% round(digits =2), " MIN"), 
         caption = "Tiempo Promedio", 
         icon = "ion-ios-timer", 
         color = "primary")
```

### Distancia  {.value-box}
```{r}
valueBox(value = "10.07 KM", 
         caption = "Distancia", 
         icon = "ion-ios-navigate-outline", 
         color = "primary")
```


### Maxima paso  {.value-box}
```{r}
valueBox(value = str_c( (CarreraLuz22$timerun/60/10.07) %>% min() %>% round(2) , " MIN/KM"),
         caption = "Mejor Paso", 
         icon = "ion-android-walk", 
         color = "primary")
```


Column { data-width=250 }
-----------------------------------------------------------------------

### Participantes  {.value-box}
```{r}
valueBox(value = 1922, 
         caption = "Participantes", 
         icon = "ion-ios-people", 
         color = "primary")
```


### Hora Fin  {.value-box}
```{r}
valueBox(value = "9:00 AM", 
         caption = "Hora Fin Aprox", 
         icon = "ion-ios-time-outline", 
         color = "primary")
```

### Tiempo Mediana  {.value-box}
```{r}
valueBox(value = str_c( (CarreraLuz22$timerun/60) %>% median() %>% round(digits =2), " MIN"), 
         caption = "Tiempo Mediana", 
         icon = "ion-ios-stopwatch-outline", 
         color = "primary")
```


### Mejor velocidad  {.value-box}
```{r}
valueBox(value = str_c((10070/min(CarreraLuz22$timerun)) %>% round(2)," M/S"), 
         caption = "Mejor velocidad", 
         icon = "ion-ios-speedometer-outline", 
         color = "primary")
```

### Mejor tiempo  {.value-box}
```{r}
valueBox(value = str_c((CarreraLuz22$timerun/60) %>% min() %>% round(digits =2), " MIN"), 
         caption = "Mejor Tiempo", 
         icon = "ion-android-stopwatch", 
         color = "primary")
```



Column { data-width=500 }
-----------------------------------------------------------------------
### 10K Luz


What is Lorem Ipsum?

Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.


### **Recorrido**

![](https://juanchocorrelon.com/wp-content/uploads/Mapa-10K-Luz-sep.jpg)


**Exploración Inicial** {data-navmenu="Da Clic Aquí para el Menu"}
==================================


Column {data-width=250}
-----------------------------------------------------------------------
### **Time Run**

```{r}
ggplot(CarreraLuz22 , aes( y = timerun)) +
  stat_halfeye(adjust = 0.5,
               justification = -0.2,
               .width = 0,
               point_colour = NA,
               fill = "#1F78B4") +
  geom_boxplot(
    width = 0.12,
    outlier.color = NA,
    alpha = 0.5,
    fill = "#1F78B4"
  ) +
  stat_dots(
    side = "left",
    justification = 1.1,
    fill = "#1F78B4"
  ) +
  coord_flip() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(axis.text.y=element_blank()
        ) +
  xlab("")
```



### **Sex**
```{r}
g <- ggplot(CarreraLuz22 , aes(x = sex, fill = sex)) +
  geom_bar() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(legend.position = "none") +
  coord_flip() +
  xlab("") 
  

ggplotly(g)
```

Column {data-width=250}
-----------------------------------------------------------------------
### **Edad**
```{r}
ggplot(CarreraLuz22 , aes( y = edad)) +
  stat_halfeye(adjust = 0.5,
               justification = -0.2,
               .width = 0,
               point_colour = NA,
               fill = "#2C3E50") +
  geom_boxplot(
    width = 0.12,
    outlier.color = NA,
    alpha = 0.5,
    fill = "#2C3E50"
  ) +
  stat_dots(
    side = "left",
    justification = 1.1,
    fill = "#2C3E50"
  ) +
  coord_flip() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(axis.text.y=element_blank()) +
  xlab("") 

```

### **Categoria**

```{r}
g <- ggplot(CarreraLuz22 %>% 
              mutate(
           categoria = fct_infreq(categoria)), 
            aes(x = categoria, fill = categoria)) +
  geom_bar() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(legend.position = "none") +
  coord_flip() +
  xlab("") 

ggplotly(g)
```


Column {data-width=250}
-----------------------------------------------------------------------
### **Origen**

```{r}
g <- ggplot(CarreraLuz22 %>% 
              mutate(
           origen = fct_infreq(origen),
           origen = fct_lump_lowfreq(origen, other_level = "Otros 48 Origenes")), 
            aes(x = origen, fill = origen)) +
  geom_bar() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(legend.position = "none") +
  coord_flip() +
  xlab("") 

ggplotly(g)
```

### **Nacionalidad**

```{r}
g <- ggplot(CarreraLuz22 %>% 
              mutate(
           nacionalidad = fct_infreq(nacionalidad),
           nacionalidad = fct_lump_lowfreq(nacionalidad, other_level = "Otras 5 Nacionalidades")
           ), 
            aes(x = nacionalidad, fill = nacionalidad)) +
  geom_bar() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(legend.position = "none") +
  coord_flip() +
  xlab("") 

ggplotly(g)
```

Column {data-width=250}
-----------------------------------------------------------------------
### **Discusión**

**Ingeniería de características y limpieza** {data-navmenu="Da Clic Aquí para el Menu"}
==================================

Column {data-width=500}
-----------------------------------------------------------------------

### **Time Run en minutos sin valor más alto**

```{r fig.width = 12}
carrera_clean <- CarreraLuz22 %>% 
  filter(timerun != max(timerun)) %>% 
  mutate(timerun_minutes = timerun/60, 
         time_under_mean = timerun_minutes <= median(timerun_minutes),
         rango_edad = cut_number(edad, 5),
         origen_refact = fct_lump_lowfreq(origen),
         nacionalidad_refact = fct_lump_lowfreq(nacionalidad))

ggplot(carrera_clean , aes( y = timerun_minutes)) +
  stat_halfeye(adjust = 0.5,
               justification = -0.2,
               .width = 0,
               point_colour = NA,
               fill = "#1F78B4") +
  geom_boxplot(
    width = 0.12,
    outlier.color = NA,
    alpha = 0.5,
    fill = "#1F78B4"
  ) +
  stat_dots(
    side = "left",
    justification = 1.1,
    fill = "#1F78B4"
  ) +
  coord_flip() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(axis.text.y=element_blank()) +
  xlab("")
```


### **Edades por rangos con obervaciones similares**

```{r}
g <- ggplot(carrera_clean , 
            aes(x = rango_edad, fill = rango_edad)) +
  geom_bar() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(legend.position = "none") +
  coord_flip() +
  xlab("") 

ggplotly(g)
```

Column {data-width=667}
-----------------------------------------------------------------------

### **Tiempos por arriba (FALSE) y por bajo (TRUE) de la mediana**

```{r}
g <- ggplot(carrera_clean , 
            aes(x = time_under_mean, fill = time_under_mean)) +
  geom_bar() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(legend.position = "none") +
  coord_flip() +
  xlab("") 

ggplotly(g)
```

### **Discusión**

**Embudo de Correlación** {data-navmenu="Da Clic Aquí para el Menu"}
==================================

Column {data-width=333}
-----------------------------------------------------------------------

### **Embudo de Correlación**

```{r}

carrera_ext <- carrera_clean %>% 
  select(sex,
         time_under_mean,
         rango_edad,
         origen_refact,
         nacionalidad_refact)

bin_car <- carrera_ext %>% 
  binarize(n_bins = 5)

correlated_carrera <- bin_car %>%
  correlate(target = time_under_mean__0)


g <- correlated_carrera %>%
    filter((feature %in% c("sex", "rango_edad"))) %>%
    plot_correlation_funnel(interactive = FALSE, limits = c(-0.5, 0.5))

g2 <- g + ggtitle("Funnel de correlación, Tiempo Bajo la Mediana / Tiempo Sobre la Mediana")

ggplotly(g2)
  
```

Column {data-width=250}
-----------------------------------------------------------------------

### **Discusión**

**Analisis Univariado** {data-navmenu="Da Clic Aquí para el Menu"}
==================================

Column {data-width=667 .tabset}
-----------------------------------------------------------------------
### **Sex**

<div style='display:flex; flex-direction:column; justify-content:space-evenly; align-items:center;'>

<div>
```{r fig.width = 12}
ggplot(carrera_clean , 
       aes(x = sex, y = timerun_minutes, fill = sex)) +
  stat_halfeye(adjust = 0.5,
               justification = -0.2,
               .width = 0,
               point_colour = NA) +
  geom_boxplot(
    width = 0.12,
    outlier.color = NA,
    alpha = 0.5
  ) +
  stat_dots(
    side = "left",
    justification = 1.1
  ) +
  coord_flip() +
  theme_tq() + 
  scale_fill_tq(theme = "light") +
  theme(legend.position = "none")

```
</div>

<div>
```{r}

carrera_clean %>%                             
  group_by(sex) %>% 
  summarize(min = min(timerun_minutes),
            q1 = quantile(timerun_minutes, 0.25),
            median = median(timerun_minutes),
            mean = mean(timerun_minutes),
            q3 = quantile(timerun_minutes, 0.75),
            max = max(timerun_minutes)) %>% 
  mutate(across(where(is.numeric),~ round(.,2))) %>% 
  knitr::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "responsive"))
```
</div>

</div>

### **Rango Edad**

<div style='display:flex; flex-direction:column; justify-content:space-evenly; align-items:center;'>

<div>
```{r fig.width = 12}

ggplot(carrera_clean %>% 
         mutate(rango_edad = fct_reorder(rango_edad, timerun, median)), 
       aes(x = rango_edad, y = timerun_minutes, fill = rango_edad)) +
  stat_halfeye(adjust = 0.5,
               justification = -0.2,
               .width = 0,
               point_colour = NA) +
  geom_boxplot(
    width = 0.12,
    outlier.color = NA,
    alpha = 0.5
  ) +
  stat_dots(
    side = "left",
    justification = 1.1
  ) +
  coord_flip() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  theme(legend.position = "none")

```
</div>

<div>
```{r}

carrera_clean %>%     
  mutate(rango_edad = fct_reorder(rango_edad, timerun, median)) %>% 
  group_by(rango_edad) %>% 
  summarize(min = min(timerun_minutes),
            q1 = quantile(timerun_minutes, 0.25),
            median = median(timerun_minutes),
            mean = mean(timerun_minutes),
            q3 = quantile(timerun_minutes, 0.75),
            max = max(timerun_minutes)) %>% 
  mutate(across(where(is.numeric),~ round(.,2))) %>% 
  knitr::kable(format = "html") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "responsive"))
```
</div>

</div>

Column {data-width=333}
-----------------------------------------------------------------------
### **Discusión**

**Analisis Multivariado** {data-navmenu="Da Clic Aquí para el Menu"}
==================================

Column {data-width=334}
-----------------------------------------------------------------------
### **Sex / Edad**

```{r fig.height= 13, fig.width=10}
ggplot(carrera_clean , 
       aes(x = sex, y = timerun_minutes, fill = sex)) +
  stat_halfeye(adjust = 0.5,
               justification = -0.2,
               .width = 0,
               point_colour = NA) +
  geom_boxplot(
    width = 0.12,
    outlier.color = NA,
    alpha = 0.5
  ) +
  stat_dots(
    side = "left",
    justification = 1.1
  ) +
  coord_flip() +
  theme_tq() +
  scale_fill_tq(theme = "light") +
  facet_grid(vars(rango_edad)) +
  theme(legend.position = "none",
        panel.spacing = unit(0, "lines"),
        text = element_text(size = 20)) +
  ylab("Minutos")+
  xlab(NULL)+
  scale_y_continuous(breaks = seq(40,110, 20))
```

Column {data-width=333}
-----------------------------------------------------------------------
### **Tabla**
 <br>
 <br>
 <br>
 <br>
 <br>

 

```{r}
carrera_clean %>% 
  group_by(sex,
           rango_edad) %>% 
  summarize(min = min(timerun_minutes),
            q1 = quantile(timerun_minutes, 0.25),
            median = median(timerun_minutes),
            mean = mean(timerun_minutes),
            q3 = quantile(timerun_minutes, 0.75),
            max = max(timerun_minutes)) %>% 
  mutate(across(where(is.numeric),~ round(.,2))) %>% 
  rename(edad = rango_edad) %>% 
  DT::datatable(rownames = FALSE,
                options = list(
                  "pageLength" = 40,
                  lengthChange = FALSE,
                  searching = FALSE,
                  paging = FALSE,
                  info = FALSE,
                  headerCallback = DT::JS(
                    "function(thead) {",
                    "  $(thead).css('font-size', '0.9em');",
                    "}"
                    ),
                  order = list(4, 'asc')
  ),
                ) %>% 
  DT::formatStyle(columns = c(1:8), fontSize = '90%')
```



Column {data-width=333}
-----------------------------------------------------------------------
### **Discusión**


**Conclusión** {data-navmenu="Da Clic Aquí para el Menu"}
==================================

![](https://juanchocorrelon.com/wp-content/uploads/bannerluz2022-1-min-scaled.jpg)